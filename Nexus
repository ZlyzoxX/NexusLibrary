-- Fixed NexusUI Library - Proper Drawing API mouse handling (No nil Connect errors)
local NexusUI = {}
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")

local Drawings = {}

local function New(class, props)
    local obj = Drawing.new(class)
    for k, v in pairs(props or {}) do
        obj[k] = v
    end
    table.insert(Drawings, obj)
    return obj
end

-- Mouse utils
local MousePos = Vector2.new(0, 0)
local MouseDown = false
UIS.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        MousePos = Vector2.new(input.Position.X, input.Position.Y)
    end
end)
UIS.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then MouseDown = true end
end)
UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then MouseDown = false end
end)

local function IsMouseOver(pos, size)
    return MousePos.X >= pos.X and MousePos.X <= pos.X + size.X and MousePos.Y >= pos.Y and MousePos.Y <= pos.Y + size.Y
end

function NexusUI:Create(options)
    options = options or {}
    local Window = {
        Name = options.Name or "Nexus UI",
        Size = options.Size or Vector2.new(500, 600),
        Position = options.Position or Vector2.new(200, 200),
        Tabs = {},
        CurrentTab = nil,
        Dragging = false,
        DragStart = Vector2.new()
    }

    -- Main elements
    local Main = New("Square", {Filled = true, Color = Color3.fromRGB(25, 25, 35), Size = Window.Size, Position = Window.Position, Transparency = 0.95})
    local TitleBar = New("Square", {Filled = true, Color = Color3.fromRGB(20, 20, 30), Size = Vector2.new(Window.Size.X, 40), Position = Window.Position})
    local TitleText = New("Text", {Text = Window.Name, Size = 20, Position = Window.Position + Vector2.new(15, 10), Color = Color3.fromRGB(230, 230, 255), Outline = true})

    -- Dragging + Clicking logic in loop
    RS.RenderStepped:Connect(function()
        -- Dragging
        if MouseDown and IsMouseOver(TitleBar.Position, TitleBar.Size) and not Window.Dragging then
            Window.Dragging = true
            Window.DragStart = MousePos - Window.Position
        end
        if Window.Dragging then
            Window.Position = MousePos - Window.DragStart
            Main.Position = Window.Position
            TitleBar.Position = Window.Position
            TitleText.Position = Window.Position + Vector2.new(15, 10)
            -- Update other elements here
        end
        if not MouseDown then
            Window.Dragging = false
        end
    end)

    function Window:NewTab(name)
        local tabIndex = #Window.Tabs + 1
        local tabBtnPos = Window.Position + Vector2.new(10 + (tabIndex - 1) * 130, 45)
        local TabBtn = New("Square", {Filled = true, Color = Color3.fromRGB(35, 35, 50), Size = Vector2.new(120, 35), Position = tabBtnPos})
        local TabText = New("Text", {Text = name, Size = 16, Center = true, Position = tabBtnPos + Vector2.new(60, 8), Color = Color3.fromRGB(180, 180, 200)})

        local Tab = {Elements = {}}

        TabBtn.ClickCallback = function() Window.CurrentTab = Tab end  -- Set active tab

        -- Manual click detection for tab
        RS.RenderStepped:Connect(function()
            if MouseDown and IsMouseOver(TabBtn.Position, TabBtn.Size) and not Window.ClickHandled then
                Window.ClickHandled = true
                if TabBtn.ClickCallback then TabBtn.ClickCallback() end
            end
            if not MouseDown then Window.ClickHandled = false end
        end)

        -- Similar for Toggle/Button inside tab...
        function Tab:Toggle(opts)
            local y = 80 + #Tab.Elements * 50
            local state = opts.Default or false
            local togPos = Window.Position + Vector2.new(Window.Size.X - 60, y)
            local toggle = New("Square", {Filled = true, Color = state and Color3.fromRGB(80, 180, 255) or Color3.fromRGB(60, 60, 70), Size = Vector2.new(40, 20), Position = togPos})
            local label = New("Text", {Text = opts.Name, Position = Window.Position + Vector2.new(20, y-5), Color = Color3.fromRGB(220, 220, 220), Size = 15})

            RS.RenderStepped:Connect(function()
                if MouseDown and IsMouseOver(toggle.Position, toggle.Size) then
                    state = not state
                    toggle.Color = state and Color3.fromRGB(80, 180, 255) or Color3.fromRGB(60, 60, 70)
                    if opts.Callback then opts.Callback(state) end
                end
            end)
        end

        -- Add Button similarly with manual detection

        table.insert(Window.Tabs, Tab)
        return Tab
    end

    return Window
end

return NexusUI
